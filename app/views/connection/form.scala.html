@import models.template.Icons
@(user: Option[models.user.User], conn: models.connection.ConnectionSettings, title: String, isNew: Boolean, errors: Seq[FormError] = Nil)(
    implicit request: Request[AnyContent], session: Session, flash: Flash, messages: Messages
) @layout.simple(user, "Edit " + title, debug = false) {
  @components.formErrors(errors)
  <div class="row">
    <form id="connection-form" class="col s12" method="post" action="@routes.ConnectionSettingsController.save(conn.id)">
      <div class="card">
        <div class="card-content">
          <span class="card-title">@title</span>

          <!-- Name, engine -->
          <div class="row" style="margin-bottom: 0;">
            <div class="input-field col s12 m6">
              <input id="form-name" name="name" type="text" value="@conn.name" />
              <label for="form-name">Connection Name</label>
            </div>

            <div class="input-field col s12 m6">
              <select id="form-engine" name="engine">
                @models.engine.DatabaseEngine.all.map { e =>
                  @if(e == conn.engine) {
                    <option value="@e.id" selected="selected">@e.name</option>
                  } else {
                    <option value="@e.id">@e.name</option>
                  }
                }
              </select>
              <label for="form-engine">Database Engine</label>
            </div>
          </div>

          <!-- Username, password -->
          <div class="row" style="margin-bottom: 0;">
            <div class="input-field col s12 m6">
              <input id="form-username" name="databaseUsername" type="text" value="@conn.username" />
              <label for="form-username">Username</label>
            </div>

            <div class="input-field col s12 m6">
              <input id="form-password" name="databasePassword" type="password" value="" />
              <label for="form-password">Password</label>
            </div>
          </div>

          <!-- Radio selection -->
          <div class="row" style="margin-bottom: 0;">
            <div class="col s12">
              <div class="card-panel option-panel">
                <!-- Connection fields -->
                <div class="row" style="margin-bottom: 0;">
                  <div class="input-field col s4 m2">
                    <div class="view-url-link">
                      <input id="form-toggle-fields" name="toggle" type="radio" value="fields" @if(conn.urlOverride.isEmpty) { checked="checked" }>
                      <label for="form-toggle-fields">Fields</label>
                    </div>
                  </div>

                  <div class="input-field col s8 m4">
                    <input id="form-host" name="host" type="text" value="@conn.host" @if(conn.urlOverride.isDefined) { disabled="disabled" } />
                    <label for="form-host">Host</label>
                  </div>

                  <div class="input-field col s4 m2">
                    <input id="form-port" name="port" type="text" value="@conn.port.getOrElse(conn.engine.defaultPort)" @if(conn.urlOverride.isDefined) { disabled="disabled" } />
                    <label for="form-port">Port</label>
                  </div>

                  <div class="input-field col s8 m4">
                    <input id="form-dbname" name="dbName" type="text" value="@conn.dbName" @if(conn.urlOverride.isDefined) { disabled="disabled" } />
                    <label for="form-dbname">Database Name</label>
                  </div>

                  <input id="form-extra" name="extra" type="hidden" value="@conn.extra" />
                </div>

                <!-- Jdbc url -->
                <div class="row" style="margin-bottom: 0;">
                  <div class="input-field col s4 m2">
                    <div class="view-keys-link">
                      <input id="form-toggle-url" name="toggle" type="radio" value="url" @if(conn.urlOverride.isDefined) { checked="checked" }>
                      <label for="form-toggle-url">URL</label>
                    </div>
                  </div>

                  <div class="input-field col s8 m10">
                    <input id="form-url-override" name="urlOverride" type="text" value="@conn.url" @if(conn.urlOverride.isEmpty) { disabled="disabled" } />
                    <label for="form-url-override">Jdbc Url</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Permissions -->
          <div class="row" style="margin-bottom: 0;">
            @views.html.connection.permissions("read", conn.read, Icons.user, "Available To")
            @views.html.connection.permissions("edit", conn.edit, Icons.adHocQuery, "Editable By")
          </div>

          <!-- Description -->
          <div class="row" style="margin-bottom: 0;">
            <div class="input-field col s12">
              <input id="form-description" name="description" type="text" value="@conn.description" />
              <label for="form-description">Description</label>
            </div>
          </div>
        </div>
        <div class="card-action">
          <button class="right btn theme waves-effect waves-light" type="submit">@if(isNew) { Create } else { Save }</button>
          <a id="test-connection-button" class="right btn-flat theme-text" style="margin-right: 12px;" href="">Test</a>
          <a class="theme-text" href="@routes.HomeController.home()">Cancel</a>
          @if((!isNew) && conn.id != services.database.core.MasterDatabase.connectionId) {
            <a class="btn-flat theme-text" onclick="onDelete();return false;">Delete</a>
          }
          <div style="clear: both;"></div>
        </div>
      </div>
    </form>
  </div>

  <script>
    function onDelete() {
      var confirmed = confirm('Are you certain you\'d like to delete this connection?');
      if(confirmed) {
        window.location = '@routes.ConnectionSettingsController.delete(conn.id) ';
      }
      return false;
    }

    $(function() {

      // Engine select
      var engineSelect = $('#form-engine');
      engineSelect.material_select();
      engineSelect.change(function(e) {
        var newUrl = 'jdbc:';
        var newPort = 0;
        switch(e.currentTarget.value) {
          @models.engine.DatabaseEngine.all.map { de =>
          case '@de.id':
              newUrl = '@de.exampleUrl';
              newPort = @de.defaultPort;
              break;
          }
          default:
            console.log('Unhandled engine [' + e.currentTarget.value + ']');
            break;
        }
        $('#form-url').val(newUrl);
        $('#form-port').val(newPort);
      });

      // Field toggle
      $('#form-toggle-fields').on('click', function() {
        $('#form-host').prop('disabled', false);
        $('#form-port').prop('disabled', false);
        $('#form-dbname').prop('disabled', false);
        $('#form-url-override').prop('disabled', true);
      });
      $('#form-toggle-url').on('click', function() {
        $('#form-host').prop('disabled', true);
        $('#form-port').prop('disabled', true);
        $('#form-dbname').prop('disabled', true);
        $('#form-url-override').prop('disabled', false);
      });

      // Test connection
      $('#test-connection-button').on('click', function() {
        var serialized = $('#connection-form').serializeArray();
        var s;
        var data = {};
        for(s in serialized){
          data[serialized[s]['name']] = serialized[s]['value']
        }

        $.post('@routes.ConnectionTestController.test(conn.id)', data, function(ret) {
          if(ret.indexOf('ok:') === 0) {
            Materialize.toast(ret.substring(3), 4000);
          } else if(ret.indexOf('error:') === 0) {
            Materialize.toast(ret.substring(7), 4000);
          } else {
            Materialize.toast(ret, 4000);
          }
        });

        return false;
      });
    });
  </script>
}
