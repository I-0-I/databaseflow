@import models.template.Icons
@(user: Option[models.user.User], conn: models.connection.ConnectionSettings, title: String, isNew: Boolean, errors: Seq[FormError] = Nil)(
    implicit request: Request[AnyContent], session: Session, flash: Flash, messages: Messages
) @layout.simple(user, "Edit " + title, debug = false) {
  @components.formErrors(errors)
  <div class="row">
    <form class="col s12" method="post" action="@routes.ConnectionSettingsController.save(conn.id)">
      <div class="card">
        <div class="card-content">
          <span class="card-title">@title</span>
          <div class="row" style="margin-bottom: 0;">
            <div class="input-field col s12 m6">
              <input id="form-name" name="name" type="text" value="@conn.name" />
              <label for="form-name">Connection Name</label>
            </div>

            <div class="input-field col s12 m6">
              <select id="form-engine" name="engine">
                @models.engine.DatabaseEngine.all.map { e =>
                  @if(e == conn.engine) {
                    <option value="@e.id" selected="selected">@e.name</option>
                  } else {
                    <option value="@e.id">@e.name</option>
                  }
                }
              </select>
              <label for="form-engine">Database Engine</label>
            </div>

            <div class="input-field col s12">
              <input id="form-url" name="url" type="text" value="@conn.url" />
              <label for="form-url">Jdbc Url</label>
            </div>

            <div class="input-field col s12 m6">
              <input id="form-username" name="databaseUsername" type="text" value="@conn.username" />
              <label for="form-username">Username</label>
            </div>

            <div class="input-field col s12 m6">
              <input id="form-password" name="databasePassword" type="password" value="" />
              <label for="form-password">Password</label>
            </div>

            @views.html.connection.permissions("read", conn.read, Icons.user, "Available To")
            @views.html.connection.permissions("edit", conn.edit, Icons.adHocQuery, "Editable By")
          </div>
        </div>
        <div class="card-action">
          <button class="right btn theme waves-effect waves-light" type="submit">@if(isNew) { Create } else { Save }</button>
          <a class="right btn-flat theme-text" href="@routes.HomeController.home()">Cancel</a>
          @if((!isNew) && conn.id != services.database.MasterDatabase.connectionId) {
            <a class="btn-flat theme-text" onclick="onDelete();return false;">Delete</a>
          }
          <div style="clear: both;"></div>
        </div>
      </div>
    </form>
  </div>

  <script>
    function onDelete() {
      var confirmed = confirm('Are you certain you\'d like to delete this connection?');
      if(confirmed) {
        window.location = '@routes.ConnectionSettingsController.delete(conn.id) ';
      }
      return false;
    }

    $(function() {
      var engineSelect = $('#form-engine');
      engineSelect.material_select();
      engineSelect.change(function(e) {
        var newUrl = "jdbc:";
        switch(e.currentTarget.value) {
          @models.engine.DatabaseEngine.all.map { de =>
            case '@de.id':
              newUrl = '@de.exampleUrl';
              break;
          }
          default:
            console.log('Unhandled engine [' + e.currentTarget.value + ']');
            break;
        }
        $('#form-url').val(newUrl);
      });
    });
  </script>
}
